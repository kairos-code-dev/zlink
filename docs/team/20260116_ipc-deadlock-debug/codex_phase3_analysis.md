# Phase 3 Strand 직렬화 분석 (Codex)

## 결론 (권장 옵션)
**Option 1: Timer/Handshake 핸들러 추가 래핑 후 재시도**

Strand 직렬화의 목적은 “해당 엔진에 들어오는 모든 완료 핸들러가 하나의 직렬화된 실행 컨텍스트를 공유”하도록 만드는 것입니다. 현재 구현은 read/write/restart_input만 strand로 묶였고, timer/handshake는 strand 밖에서 실행되므로 “부분 직렬화” 상태입니다. 이 상태에서는 strand 내부 코드와 외부 핸들러 간 경합/순서 역전이 여전히 가능하고, 그 결과 실패율이 개선되지 않을 수 있습니다. 즉, Strand 접근 자체를 평가하기 전에 **완전한 핸들러 직렬화**를 먼저 달성해야 합니다.

## 핵심 질문별 분석

### 1. dispatch vs post 차이가 문제인가?
- **가능성 있음 (중간 수준)**
- `dispatch`는 호출 스레드가 strand에 있으면 즉시 실행되고, 아니면 큐잉됩니다. 따라서 호출 컨텍스트가 섞이면 **동일 함수의 실행 순서와 타이밍이 일정하지 않게 됩니다**.
- 다만 현재 실패율 악화가 `dispatch` 하나로 설명되기 어렵습니다. read/write/handshake/timer의 **부분 직렬화**가 더 큰 원인일 가능성이 높습니다.
- 따라서 `dispatch → post` 변경은 **Option 1 완료 후 보완 실험**으로 권장됩니다.

### 2. restart_input_internal()의 반환값 손실이 문제인가?
- **가능성 낮음**
- 기존 로직이 반환값을 통해 상위 로직의 분기를 제어하는 구조라면 위험하지만, 현재 `restart_input()`이 `true`를 항상 반환하도록 바뀐 것은 “진행 트리거” 역할에 가까워 보입니다.
- deadlock이 “실행 경로 자체가 호출되지 않는 문제”라면 반환값 손실보다는 **호출 시점/컨텍스트** 문제가 더 유력합니다.

### 3. Timer/Handshake 핸들러 미래핑이 원인인가?
- **가능성 높음**
- Timer/Handshake 핸들러는 연결/상태 전이의 핵심 이벤트입니다. 이들이 strand 밖에서 실행되면, strand 내부의 read/write/restart_input과 **순서 보장 실패**가 발생할 수 있습니다.
- 특히 handshake는 연결 초기 상태 머신에 직접 개입하며, read/write 직렬화를 우회하면 “절반만 직렬화된 상태”가 됩니다.
- 따라서 먼저 이 핸들러를 strand에 묶고 성능/성공률을 재측정해야 합니다.

### 4. Strand 오버헤드가 IPC에서 오히려 해가 되는가?
- **가능성 낮음 (현 단계에서는 결론 유보)**
- strand 자체 오버헤드는 존재하지만, 2K 메시지에서 10%p 악화는 **오버헤드만으로 설명하기 어렵습니다**. 특히 실패율 악화는 “성능 문제”보다는 “동기화 누락”에 더 가깝습니다.
- 즉, 아직 “strand가 해롭다”를 결론 내릴 단계가 아닙니다. **완전 직렬화가 달성된 다음** 판단해야 합니다.

### 5. 구현 자체에 버그가 있는가?
- **가능성 중간**
- 버그라기보다 “직렬화 범위가 불완전”한 설계 결함에 가깝습니다. read/write만 strand에 묶은 상태는 사실상 **부분 직렬화**이며, 교착의 핵심 경로를 여전히 허용합니다.

## 추천 실행 순서
1. **Option 1 수행**: Timer/Handshake 핸들러를 strand에 래핑하여 “완전 직렬화” 상태를 만든다.
2. 동일 조건에서 2K/10K 반복 테스트를 재실행한다.
3. 결과가 개선되지 않으면, `dispatch → post` 변경을 추가 실험으로 진행한다.
4. 그래도 개선이 없으면 Strand 접근 자체를 재평가한다(Option 3).

## 결론 요약
- Strand 접근의 평가가 **불완전한 직렬화 상태**에서 이뤄졌기 때문에 현재 결과만으로 Strand 실패를 결론 내리면 조급합니다.
- 따라서 **Option 1이 우선**이며, 이후 `dispatch/post`와 성능 오버헤드를 순차적으로 실험하는 것이 합리적입니다.
